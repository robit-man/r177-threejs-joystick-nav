<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>XR Dolly + Eased Jump/Crouch Demo</title>
  <style>
    html,body { margin:0; height:100%; overflow:hidden; background:#111; color:#eee; font-family: monospace; }
    #feedback {
      position: fixed;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      width: 80%;
      height: 1rem;
      background: rgba(255,255,255,0.05);
      border-radius: 0.5rem;
      overflow: hidden;
    }
    #fill { width:0%; height:100%; background: #0f0; }
    #hint {
      position: fixed;
      top: 1rem; left: 1rem;
      font-size: .75rem;
      background: rgba(0,0,0,0.5);
      padding: .3em .6em; border-radius: 4px;
      pointer-events: none;
    }
  </style>
</head>
<body>

  <div id="feedback"><div id="fill"></div></div>
  <div id="hint">L: move/run • R: yaw/jump/crouch • hold down for crouch</div>

  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.177.0/build/three.module.min.js",
      "VRButton": "https://cdn.jsdelivr.net/npm/three@0.177.0/examples/jsm/webxr/VRButton.js",
      "XRControllerModelFactory": "https://cdn.jsdelivr.net/npm/three@0.177.0/examples/jsm/webxr/XRControllerModelFactory.js"
    }
  }
  </script>

  <script type="module">
  import * as THREE from 'three';
  import { VRButton } from 'VRButton';
  import { XRControllerModelFactory } from 'XRControllerModelFactory';

  // ── Renderer & VRButton ─────────────────────────────────────────────
  const renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setPixelRatio(window.devicePixelRatio);
  renderer.setSize(innerWidth, innerHeight);
  renderer.xr.enabled = true;
  document.body.appendChild(renderer.domElement);
  document.body.appendChild(VRButton.createButton(renderer));

  // ── Scene, Camera, Dolly ─────────────────────────────────────────────
  const scene  = new THREE.Scene();
  scene.background = new THREE.Color(0x202020);
  const camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.05, 1000);
  camera.position.set(0,1.6,0);
  const dolly = new THREE.Group();
  dolly.add(camera);
  scene.add(dolly);

  // ── Simple world ─────────────────────────────────────────────────────
  scene.add(new THREE.HemisphereLight(0xffffbb, 0x080820, .8));
  scene.add(new THREE.GridHelper(40, 40, 0x444444, 0x333333));

  // ── Controllers ──────────────────────────────────────────────────────
  const factory = new XRControllerModelFactory();
  renderer.xr.addEventListener('sessionstart', ()=>{
    const ctrlL = renderer.xr.getController(0);
    const ctrlR = renderer.xr.getController(1);
    dolly.add(ctrlL, ctrlR);
    const gripL = renderer.xr.getControllerGrip(0);
    const gripR = renderer.xr.getControllerGrip(1);
    gripL.add(factory.createControllerModel(gripL));
    gripR.add(factory.createControllerModel(gripR));
    dolly.add(gripL, gripR);
  });

  // ── Movement State ───────────────────────────────────────────────────
  const FWD   = new THREE.Vector3();
  const RIGHT = new THREE.Vector3();

  let runMul      = 1;
  const MIN_RUN         = 1;
  const MAX_RUN         = 3;
  const RUN_EASE        = 3;    // lerp speed
  const BASE_SPEED      = 2;    // m/s
  const YAW_SPEED       = 1.5;  // rad/s
  const DEADZONE        = 0.2;

  // Jump/crouch heights based on camera's initial y
  const STAND_HEIGHT    = camera.position.y;        // 1.6
  const JUMP_HEIGHT     = STAND_HEIGHT * 1.5;       // 2.4
  const CROUCH_HEIGHT   = STAND_HEIGHT * 0.5;       // 0.8
  const JUMP_EASE       = 4;    // lerp speed up/down
  const CROUCH_EASE     = 6;    // lerp speed into/out of crouch

  let jumpState = 'idle';        // 'idle' | 'up' | 'down'
  let jumpTarget = STAND_HEIGHT;

  const clock = new THREE.Clock();
  const fillBar = document.getElementById('fill');

  renderer.setAnimationLoop(()=>{
    const dt = clock.getDelta();
    if(renderer.xr.isPresenting) xrMove(dt);
    renderer.render(scene, camera);
  });

  function xrMove(dt) {
    const ses = renderer.xr.getSession();
    if(!ses) return;

    // basis vectors
    camera.getWorldDirection(FWD);
    FWD.y = 0; FWD.normalize();
    RIGHT.crossVectors(FWD, new THREE.Vector3(0,1,0)).normalize();

    ses.inputSources.forEach(src => {
      const gp = src.gamepad;
      if(!gp) return;

      const sx = gp.axes[2]||0;
      const sy = gp.axes[3]||0;
      const mag = Math.hypot(sx, sy);

      // haptics + UI
      if(gp.hapticActuators?.[0] && mag > DEADZONE) {
        gp.hapticActuators[0].pulse(mag, 20);
      }
      fillBar.style.width = `${THREE.MathUtils.clamp(mag,0,1)*100}%`;

      // ── Left: strafe & eased run ───────────────────────────────────
      if(src.handedness === 'left') {
        const squeeze = gp.buttons[1]?.value || 0;
        const targetRun = squeeze > 0.5 ? MAX_RUN : MIN_RUN;
        runMul += (targetRun - runMul) * RUN_EASE * dt;
        if(mag > DEADZONE) {
          dolly.position.addScaledVector(RIGHT, sx * BASE_SPEED * dt * runMul);
          dolly.position.addScaledVector(FWD,  -sy * BASE_SPEED * dt * runMul);
        }
      }

      // ── Right: yaw + jump/crouch state machine ────────────────────
      if(src.handedness === 'right') {
        // yaw
        if(Math.abs(sx) > DEADZONE) {
          dolly.rotation.y -= sx * YAW_SPEED * dt;
        }
        // trigger jump once
        if(jumpState === 'idle' && sy < -DEADZONE) {
          jumpState = 'up';
          jumpTarget = JUMP_HEIGHT;
        }
        // jump/crouch logic
        if(jumpState !== 'idle') {
          // rising or falling
          dolly.position.y = THREE.MathUtils.lerp(dolly.position.y, jumpTarget, JUMP_EASE * dt);
          if(Math.abs(dolly.position.y - jumpTarget) < 0.01) {
            if(jumpState === 'up') {
              jumpState = 'down';
              jumpTarget = STAND_HEIGHT;
            } else {
              jumpState = 'idle';
            }
          }
        } else {
          // crouch while holding down
          if(sy > DEADZONE) {
            dolly.position.y = THREE.MathUtils.lerp(dolly.position.y, CROUCH_HEIGHT, CROUCH_EASE * dt);
          } else {
            // ease back to stand
            dolly.position.y = THREE.MathUtils.lerp(dolly.position.y, STAND_HEIGHT, CROUCH_EASE * dt);
          }
        }
      }
    });
  }

  // ── Resize ───────────────────────────────────────────────────────────
  window.addEventListener('resize', ()=>{
    camera.aspect = innerWidth/innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth, innerHeight);
  });
  </script>
</body>
</html>
